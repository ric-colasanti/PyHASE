<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Latest compiled and minified CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css"
    />

    <title>Template</title>
  </head>

  <body>
    <div class="container" style="margin-top: 80px">
      <div id="display"></div>
    </div>

    <!-- Latest compiled JavaScript -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    
      function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
        var angleInRadians = ((angleInDegrees - 90) * Math.PI) / 180.0;

        return {
          x: centerX + radius * Math.cos(angleInRadians),
          y: centerY + radius * Math.sin(angleInRadians),
        };
      }

      function describeArc(x, y, radius, startAngle, endAngle) {
        var start = polarToCartesian(x, y, radius, endAngle);
        var end = polarToCartesian(x, y, radius, startAngle);

        var largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";

        var d = [
          "M",
          start.x,
          start.y,
          "A",
          radius,
          radius,
          0,
          largeArcFlag,
          0,
          end.x,
          end.y,
        ].join(" ");

        return d;
      }

      let population = [];

      var frame = SVG("svg");
      frame.setAttribute("width", "500");
      frame.setAttribute("height", "500");
      frame.setAttribute("border-style", "solid");
      frame.setAttribute("id", "svg02");
      var container = document.getElementById("display");
      container.appendChild(frame);

      //var frame = document.getElementById("svg01");

      let shoppedOut = false;
      const size = 50;

      function getAngleDegrees(fromX, fromY, toX, toY, force360 = true) {
        let deltaX = fromX - toX;
        let deltaY = fromY - toY; // reverse
        let radians = Math.atan2(deltaY, deltaX);
        let degrees = (radians * 180) / Math.PI - 90; // rotate
        if (force360) {
          while (degrees >= 360) degrees -= 360;
          while (degrees < 0) degrees += 360;
        }
        return degrees;
      }

      function rndInt(maxVal) {
        return Math.floor(Math.random() * maxVal);
      }

      class Pos {
        constructor(xPos, yPos) {
          this.xPos = xPos;
          this.yPos = yPos;
        }

        move(dx, dy) {
          this.xPos += dx;
          this.yPos += dy;
        }

        dx(point) {
          return this.xPos - point.xPos;
        }
        dy(point) {
          return this.yPos - point.yPos;
        }
      }

      class Shop{
        constructor(sClass,pos){
          this.customers = 0
          this.sClass = sClass;
          this.highCustomers = 0;
          this.lowCustomers = 0
          this.circle
        }
      }

      class Person {
        constructor(sClass, pos) {
          this.sClass = sClass;
          this.shape = SVG("polygon");
          this.shape.setAttribute("fill", "red");
          this.shape.setAttribute("stroke", "black");
          let array = [
            [0, -10],
            [10, 10],
            [0, 5],
            [-10, 10],
          ];
          for (let value of array) {
            let point = frame.createSVGPoint();
            point.x = value[0];
            point.y = value[1];
            this.shape.points.appendItem(point);
          }
          this.home = new Pos(pos.xPos, pos.yPos);
          this.pos = pos;
          this.target = null;
          this.shop = null;
          this.deg = 0;
          this.atTarget = false;
        }

        setTarget(target) {
          this.target = new Pos(target.xPos, target.yPos);
          let dx = target.dx(this.pos);
          let dy = target.dy(this.pos);
          this.dx = (dx / Math.sqrt(dx * dx + dy * dy)) * 3;
          this.dy = (dy / Math.sqrt(dx * dx + dy * dy)) * 3;

          this.deg = getAngleDegrees(
            this.pos.xPos,
            this.pos.yPos,
            this.target.xPos,
            this.target.yPos,
            false
          );
        }

        distance(xPos, yPos) {
          let dx = Math.abs(this.xPos - xPos);
          let dy = Math.abs(this.yPos - yPos);
          return Math.sqrt(dx * dx + dy * dy);
        }

        draw() {
          if (this.sClass == 0) {
            this.shape.setAttribute("fill", "red");
          } else {
            this.shape.setAttribute("fill", "blue");
          }
          this.shape.setAttribute(
            "transform",

            "translate(" +
              this.pos.xPos +
              "," +
              this.pos.yPos +
              ") rotate(" +
              this.deg +
              " " +
              0 +
              " " +
              0 +
              " ) scale(0.5,0.5)"
          );
        }
        
        move() {
          if (
            Math.abs(this.pos.xPos - this.target.xPos) > 4 ||
            Math.abs(this.pos.yPos - this.target.yPos) > 4
          ) {
            this.atTarget = false;
            this.pos.move(this.dx, this.dy);
            this.draw();
          } else {
            this.atTarget = true;
          }
        }
      }

      function SVG(elementName) {
        return document.createElementNS(
          "http://www.w3.org/2000/svg",
          elementName
        );
      }
      let shops = [];
      const d = new Date();
      let time = d.getTime();

      function setup() {
        for (let i = 0; i < 20; i++) {
          const xPos = rndInt(size);
          const yPos = rndInt(size);
          shops.push(new Pos(xPos * 10, yPos * 10));
          let group = SVG("g")
          let arc = SVG("path");
          arc.setAttribute("stroke","#111688")
          arc.setAttribute("stroke-width",3)
          arc.setAttribute("fill","none")
          arc.setAttribute("d", describeArc(xPos*10, yPos*10, 15, 50, 250));
          let circle = SVG("circle")
          circle.setAttribute("cx", xPos * 10);
          circle.setAttribute("cy", yPos * 10);
          circle.setAttribute("r", 15);
          circle.setAttribute("fill","rgba(255,0,0,0.3)");
          group.appendChild(circle);
          group.appendChild(arc);
          frame.append(group)
        }
        // for (let x = 1; x < 49; x++) {
        //   for (let y = 1; y < 49; y++) {
        for (let i = 0; i < size * size * 0.8; i++) {
          const xPos = rndInt(size);
          const yPos = rndInt(size);
          const person = new Person(rndInt(2), new Pos(xPos * 10, yPos * 10));
          let dMin = 10000;
          let s = 0;
          let shop = 0;
          for (s = 0; s < shops.length; s++) {
            const d = person.distance(shops[s]);
            if (d < dMin) {
              dMin = d;
              shop = s;
            }
          }
          person.shop = shops[rndInt(shops.length)];
          person.setTarget(person.shop);
          population.push(person);
          frame.appendChild(person.shape);
          person.draw();
        }
        // }
        frame.setAttribute("transform", "scale(1,1)");
      }

      update = function () {
        const d = new Date();
        if (d.getTime() - time > 3000) {
          for (let i = 0; i < population.length; i++) {
            let person = population[i];
            person.move();
            if (person.atTarget) {
              if (Math.random() < 0.001) {
                person.shop = shops[rndInt(shops.length)];
                person.setTarget(person.shop);
                person.atTarget = false;
              }
            }
          }
        }

        setTimeout(function () {
          window.requestAnimationFrame(update);
        }, 1);
      };

      setup();
      update();
    </script>
  </body>
</html>
